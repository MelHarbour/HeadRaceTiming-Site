<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/lib/iron-ajax/iron-ajax.html" />
<link rel="import" href="/components/iron-list.html" />
<link rel="import" href="/lib/iron-media-query/iron-media-query.html" />
<link rel="import" href="/lib/iron-icon/iron-icon.html"/>

<dom-module id="results-list">
    <template>
        <style>
            .header-row, .row {
                @apply(--layout-horizontal);
                line-height: 56px;
                padding-left: 24px;
                padding-right: 24px;
                border-bottom: 1px rgba(0, 0, 0, 0.12) solid;
            }
            .header-row {
                color: rgba(0,0,0,0.54);
            }
            .row {
                color: rgba(0,0,0,0.87);
            }
            .row:hover {
                background-color: #eeeeee;
                cursor: pointer;
            }
            .rowHighlight {
                background-color: #f5f5f5;
            }
            .startNumber {
                width: 33px;
                margin-right: 56px;
            }
            .name {
                @apply(--layout-flex);
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .intermediate, .time {
                width: 100px;
                text-align: center;
                margin-left: 56px;
            }
        </style>

        <iron-ajax id="ajax" url$="/api/competitions/[[competitionId]]/crews?s=[[searchValue]]" last-response="{{data}}" timeout="10000" on-error="updateData" on-response="updateData"></iron-ajax>
        <iron-media-query query="min-width: 840px" query-matches="{{wide}}"></iron-media-query>

        <div class="header-row">
            <div class="startNumber">Start</div>
            <div class="name">Crew Name</div>
            <div hidden$="[[_logicalNand(firstIntermediateId,wide)]]" class="intermediate">[[firstIntermediateName]]</div>
            <div hidden$="[[_logicalNand(secondIntermediateId, wide)]]" class="intermediate">[[secondIntermediateName]]</div>
            <div class="time">Finish</div>
        </div>
        <iron-list scroll-target="document" items="[[data]]" as="item" id="crewsList">
            <template>
                <div>
                    <div class$="[[_getClass(item.lastUpdate)]]" data-crew-id="[[item.id]]" onclick="location.href='/Crew/Details/' + this.dataCrewId">
                        <div class="startNumber">
                            [[item.startNumber]]
                        </div>
                        <div class="name" title="[[item.name]]">
                            [[item.name]]
                            <template is="dom-if" if="{{item.isStarted}}">
                                <iron-icon icon="rowing"></iron-icon>
                            </template>
                        </div>
                        <div hidden$="[[_logicalNand(firstIntermediateId,wide)]]" class="intermediate">
                            <template is="dom-if" if="[[!item.status]]">
                                [[_getTime(item,firstIntermediateId)]]
                                <template is="dom-if" if="[[_getTime(item,firstIntermediateId)]]">
                                    ([[_getRank(item,firstIntermediateId)]])
                                </template>
                            </template>
                        </div>
                        <div hidden$="[[_logicalNand(secondIntermediateId, wide)]]" class="intermediate">
                            <template is="dom-if" if="[[!item.status]]">
                                [[_getTime(item,secondIntermediateId)]]
                                <template is="dom-if" if="[[_getTime(item,secondIntermediateId)]]">
                                    ([[_getRank(item,secondIntermediateId)]])
                                </template>
                            </template>
                        </div>
                        <div class="time">
                            <template is="dom-if" if="{{item.status}}">
                                [[_statusCode(item.status)]]
                            </template>
                            <template is="dom-if" if="[[!item.status]]">
                                [[item.overallTime]]
                                <template is="dom-if" if="{{item.overallTime}}">
                                    ([[item.rank]])
                                </template>
                            </template>
                        </div>
                    </div>
                </div>
            </template>
        </iron-list>
    </template>

    <script>
        class ResultsList extends Polymer.Element {

            static get is() { return 'results-list'; }

            static get properties() {
                return {
                    competitionId: Number,
                    firstIntermediateName: String,
                    secondIntermediateName: String,
                    firstIntermediateId: Number,
                    secondIntermediateId: Number,
                    searchValue: String,
                    data: Array
                };
            }

            updateData() {
                var ajaxElement = this.$.ajax;
                setTimeout(function () {
                    ajaxElement.generateRequest();
                }, this.interval);
                this.interval = 15000;
                Polymer.RenderStatus.afterNextRender(this, function () {
                    this.dispatchEvent(new CustomEvent('update'));
                });
            }

            ready() {
                super.ready();
                Polymer.RenderStatus.afterNextRender(this, function () {
                    this.interval = 0;
                    this.updateData();
                });
            }

            _logicalNand(a, b) {
                return !(a && b);
            }

            _statusCode(s) {
                switch (s) {
                    case 1: return "Missing";
                    case 2: return "DNF";
                    case 3: return "DSQ";
                    case 4: return "DNS";
                }
            }

            _getRank(item, timingPoint) {
                for (var i = 0; i < item.results.length; i++) {
                    if (item.results[i].id == timingPoint)
                        return item.results[i].rank;
                }
            }

            _getTime(item, timingPoint) {
                for (var i = 0; i < item.results.length; i++) {
                    if (item.results[i].id == timingPoint)
                        return item.results[i].runTime;
                }
            }

            _getRowClass(lastUpdate) {
                return "row";
            }
        }

        customElements.define(ResultsList.is, ResultsList);
    </script>

</dom-module>